<html>
  <head>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="//d2e48ltfsb5exy.cloudfront.net/content_mj/files/custom.154-10.js"></script>
    <script type="text/javascript" src="//d2e48ltfsb5exy.cloudfront.net/content_mj/files/custom.154-10.js"></script>
    <link href="//d2e48ltfsb5exy.cloudfront.net/content_mj/files/def.ui.152-21.css" rel="stylesheet" type="text/css">
    <link href="//d2e48ltfsb5exy.cloudfront.net/content_mj/files/my.jobs.157-13.css" rel="stylesheet" type="text/css">
    <style>
    .table-striped tbody tr:nth-child(odd) td {
        background-color: #fff;
    }
    .table-striped tbody tr:nth-child(even) td {
        background-color: transparent;
    }
    </style>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">

      // Load the Visualization API and the piechart package.
      google.load('visualization', '1.0', {'packages':['corechart']});

      // Set a callback to run when the Google Visualization API is loaded.
      google.setOnLoadCallback(drawChart);

      // Callback that creates and populates a data table,
      // instantiates the pie chart, passes in the data and
      // draws it.
      function drawChart() {

        /*
        // New Accounts by Week (table 17).
        */
        var acct_data = new google.visualization.DataTable();
        acct_data.addColumn('string', 'Week Ending');
        acct_data.addColumn('number', 'New Accounts');
        acct_data.addRows([
            {% if new_accounts %}
                {% for acct in new_accounts %}
                    {% if not forloop.last %}
                    ['{{acct.0}}', {{acct.1}}],                    
                    {% endif %}
                    {% if forloop.last %}
                    ['{{acct.0}}', {{acct.1}}]                    
                    {% endif %}
                {% endfor %}
            {% endif %}
        ]);

        // Set chart options
        var acct_options = {'title':'New Accounts by Week (17)',
                       'width':1000,
                       'height':600};

        // Instantiate and draw our chart, passing in some options.
        var acct_chart = new google.visualization.ColumnChart(document.getElementById('new_accts_chart_div'));
        acct_chart.draw(acct_data, acct_options);


        /*
        // Saved Searches by Group by Week (Table 16)
        */
        var ss_data = new google.visualization.arrayToDataTable([
            {% if saved_schs %}
                    ['week ending','network','redirect','www.my.jobs',{ role: 'annotation' }],
                {% for ss in saved_schs %}
                    {% if not forloop.last %}
                    ['{{ss.0}}', {{ss.1}}, {% if ss.3 %}{{ss.2}}{%else%}0{%endif%},{% if ss.3 %}{{ss.3}}{%else%}{{ss.2}}{%endif%},''],            
                    {% endif %}
                    {% if forloop.last %}
                    ['{{ss.0}}', {{ss.1}}, {% if ss.3 %}{{ss.2}}{%else%}0{%endif%},{% if ss.3 %}{{ss.3}}{%else%}{{ss.2}}{%endif%},''] 
                    {% endif %}
                {% endfor %}
            {% endif %}
        ]);

        // Set chart options
        var ss_options = {'title':'Saved Searches by Group by Week (16)',
                       'width':1000,
                       'height':600,
                        'isStacked':true};

        // Instantiate and draw our chart, passing in some options.
        var ss_chart = new google.visualization.ColumnChart(document.getElementById('saved_schs_grp_chart_div'));
        ss_chart.draw(ss_data, ss_options);

        /*
        // Binary Resumes by Week (Table 15)
        */
        var bin_res_data = new google.visualization.arrayToDataTable([
            {% if binary_resumes %}
                    ['week ending','resume','no resume',{ role: 'annotation' }],
                {% for br in binary_resumes %}
                    {% if not forloop.last %}
                    ['{{br.0}}', {{br.1}}, {{br.2}},''],
                    {% endif %}
                    {% if forloop.last %}
                    ['{{br.0}}', {{br.1}}, {{br.2}},'']
                    {% endif %}
                {% endfor %}
            {% endif %}
        ]);

        // Set chart options
        var bin_res_options = {'title':'Binary Resume Completion by Week (15)',
                       'width':1000,
                       'height':600,
                        'isStacked':true};

        // Instantiate and draw our chart, passing in some options.
        var bin_res_chart = new google.visualization.ColumnChart(document.getElementById('bin_res_chart_div'));
        bin_res_chart.draw(bin_res_data, bin_res_options);

        
        /*
        // Resumes by Week (Table 14)
        */
        var rbw_data = new google.visualization.arrayToDataTable([
            {% if rbw %}
                    ['week ending','1-25','26-50','51-75','76-100',{ role: 'annotation' }],
                {% for br in rbw %}
                    {% if not forloop.last %}
                    ['{{br.0}}', {{br.2}}, {{br.3}},{{br.4}},{{br.5}},''],
                    {% endif %}
                    {% if forloop.last %}
                    ['{{br.0}}', {{br.2}}, {{br.3}},{{br.4}},{{br.5}},'']
                    {% endif %}
                {% endfor %}
            {% endif %}

          //['Pepperoni', 2]
        ]);

        // Set chart options
        var rbw_options = {'title':'Resume Completion by Week (14)',
                       'width':1000,
                       'height':600,
                        'isStacked':true};

        // Instantiate and draw our chart, passing in some options.
        var rbw_chart = new google.visualization.ColumnChart(document.getElementById('rbw_chart_div'));
        rbw_chart.draw(rbw_data, rbw_options);



      }
        
    </script>
</head>

<body>
<header>
    <div class="wrapper">
    <h1> DirectEmployers Metrics Date</h1>
    </div>
</header>
<section>
    <div class="section subpage">
        <div class="wrapper">
            <div class="row">
                <h2>Google Analytics</h2>
            </div>
            <div class="row">
                <div class="span4">
                    <div class="sidebar">
                    <h2 class="top">Search</h2>
                    {% if accounts %}
                    Account:<br/><select id="select_account">
                        <option 
                            value="1101211,6392841,8308612,9599997,12430800,16316580,20577364,23584545,24609654,24939159,25741851,26313745,26937129,27826544,28646010,29216021,29240965,29293285,29613651,29952564,29954972,30367743,30689069,30814211,30824274,30922762,30955275,31390202,32988266,35490901,37974452,40997820,44339952,47178210,50261450,53418614">
                            All
                        </option>
                    {% for account in accounts %}
                        <option {% if forloop.first %}SELECTED {% endif %}value="{{account.id}}">{{account.name}}</option>
                    {% endfor %}
                    </select><br/>
                    Metric:<br/>
                    <select id="select_metric">
                        <option value="none">Select...</option>                        
                        <option SELECTED value="sessions">Sessions</option>
                        <option value="organicSearches">Organic Traffic</option>
                        <option value="pageViews">Page Views</option>
                        <option value="users">Unique Visitors</option>
                    </select><br/>
                    Start Date:<br/><input id="start_date"></input><br/>
                    End Date:<br/><input id="end_date"</input><br/>
                    <button id="select_account_button" class="primary btn">
                        Get Data
                    </button>
                    </div>
                </div>
                <div class="span8">
                    <div class="sidebar">
                    <h2 class="top">Results</h2>
                    <div id="ajax_target">
                        <table class='table'>
                            <tr>
                                <th>Profile</th><th>Metric</th>
                            </tr><tr>
                                <td colspan=2 style='height: 200px'>
                                    Use the form to the left to select the data 
                                    you want.
                                </td>
                            </tr>
                        </table>
                    </div>
                    {%else%}
                    <a href="/login">Login with your Google Account</a>
                    {% endif %}
                    {% for ga in ga_data %}
                        {% if forloop.first %}
                        <tr>
                            {% for g,v in ga.items %}<th>{{g}}</th>{%endfor%}
                        </tr>
                        <tr>
                            {% for g,v in ga.items %}<td>{{v}}</td>{%endfor%}
                        </tr>
                        {% else %}
                        <tr>{% for g,v in ga.items %}<td>{{v}}</td>{%endfor%}</tr>
                        {% endif %}
                    {% endfor %}
                    </table>
                    </div>
                </div>
            </div>
            <div class="row">
                <h2>My.jobs Accounts</h2>
            </div>
            <div class="row">
                <div class="span12">
                    <div id="rbw_chart_div"></div>
                    <div id="bin_res_chart_div"></div>
                    <div id="saved_schs_grp_chart_div"></div>
                    <div id="new_accts_chart_div"></div>
                </div>
            </div>
        </div>
    </div>
</section>
<div id="ajax-busy" style="display: none;">Elapsed time: 0 seconds</div>
    <script>    
    $(document).ready(function(){
        //  getGoogleData($("#select_account").val(),$("#select_metric").val());
        $("#start_date,#end_date").datepicker({
            dateFormat: "yy-mm-dd"
            });
    });
    $("#select_account_button").click(function(){
        getGoogleData();
    })

    function getGoogleData(){
        acct = $("#select_account").val();
        acct_len = acct.split(",").length
        total_time_est = 20*acct_len;
        time = 0
        ajax_timer = setInterval(function(){
                time++;
                percent = parseInt(time/total_time_est*100)
                str = "Elapsed time: "+time+" seconds.<br/>Estimate: ("+percent+"%)"
            $("#ajax-busy").html(str);        
        },1000)
        metric = $("#select_metric").val();
        
        if(metric=="none"){return false;}
        
        start = $("#start_date").val();
        end = $("#end_date").val();
        date_str = ""
        if (start!=""){
            date_str+="&start_date="+start;
        }
        if (end!=""){
            date_str+="&end_date="+end;
        }
        $("#ajax-busy").show();
        $.ajax({
            url: "/gapi?accounts="+acct+"&metric="+metric+date_str, 
            xhrFields:{
                onprogress: function(e){
                    if (e.lengthComputable) { console.log(e.loaded) }
                }
            },
            beforeSend: function(){
                $("#select_account").prop('disabled', true);
                $("#select_metric").prop('disabled', true);
                $("#start_date").prop('disabled', true);
                $("#end_date").prop('disabled', true);
            },
            success: function(data){                
                acct = $("#select_account").val();
                metric = $("#select_metric").val();
                acct_name = $("#select_account option:selected").text();
                metric_name = $("#select_metric option:selected").text();
                
                var m_names = new Array("January", "February", "March", 
                    "April", "May", "June", "July", "August", "September", 
                    "October", "November", "December");
                
                sd = new Date(data[0]['start']+" EDT");                
                start_display = m_names[sd.getMonth()]+" ";
                start_display += sd.getDate()+", ";
                start_display += sd.getFullYear();
                
                ed = new Date(data[0]['end']+" EDT");                
                end_display = m_names[ed.getMonth()]+" ";
                end_display += ed.getDate()+", ";
                end_display += ed.getFullYear();
                
                h_str = "<h3>"+acct_name+" Profiles</h3><h4>"+metric_name+"</h4>";
                h_str+= "<b>"+start_display+"</b> to <b>"+end_display+"</b>";
                h_str+="<table class='table table-striped table-condensed table-bordered'>";
                h_str+="<tr><th>Profile</th><th>URL</th><th>"+metric_name+"</th></tr><tbody>";
                for(i=0;i<data.length;i++){
                    name = data[i]['name'];
                    value = data[i][metric]
                    url = data[i]['url'].replace("http://","").replace("/","")
                    h_str+="<tr><td>"+name+"</td>";
                    h_str+="<td><a href='http://"+url+"' target='_blank'>"+url+"</a></td>";
                    h_str+="<td>"+value+"</td></tr>";
                }
                h_str += "</tbody></table>";
                $("#ajax_target").html( h_str ) ;
                acct = $("#select_account").prop('disabled', false);
                metric = $("#select_metric").prop('disabled', false);
                $("#start_date").prop('disabled', false);
                $("#end_date").prop('disabled', false);
                $("#ajax-busy").hide();
                $("#ajax-busy").html("Elapsed time: 0 seconds");
                clearInterval(ajax_timer);
            } 
        });
    }
    </script>
</body>
</html>
